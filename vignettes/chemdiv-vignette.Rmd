---
title: "Analysing Phytochemical Diversity -- An introduction to *chemdiv*"
author: "Hampus Petrén, Tobias G. Köllner, Robert R. Junker"
date: "`r Sys.Date()`"
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Analysing Phytochemical Diversity -- An introduction to *chemdiv*}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

**The *chemdiv* package and this vignette are in development and may not be fully functional/complete**

## Introduction
*chemdiv* is an R package used to analyse phytochemical data. It contains
functions centered around calculations of phytochemical diversity and
dissimilarity. This includes the use of diversity and dissimilarity indices 
that incorporate the biosynthetic and/or structural properties of the 
phytochemical compounds for the calculations, thereby allowing comprehensive
calculations of phytochemical diversity.

*chemdiv* is currently available on GitHub: <https://github.com/hpetren/chemdiv>

This introduction serves as a tutorial explaining the main intended use of 
all the functions in the package.


## Setup
The developmental version of the package can be installed directly from GitHub
in R using the `install_github()` function from the `devtools` package.

```{r, eval = FALSE}
# Install and load devtools package
install.packages("devtools")
library("devtools")

# Install chemdiv
install_github("hpetren/chemdiv")
```

```{r}
# Load chemdiv
library(chemdiv)
```


## Using *chemdiv*

### Data formatting
Analyses in *chemdiv* will work best for sets of data, commonly generated 
by chemical ecologists using GC-MS, LC-MS or similar, where all or most 
compounds in the samples have been confidently identified.

Two separate datasets are needed to use the full set of analyses in 
the package. We illustrate this by using an example dataset, that is
included in the package, on floral scent of X individuals from Y populations 
for the plant *Arabis alpina*.
---Link to whatever dataset is used---


The first dataset, which we call the *proportions* dataset, should be a 
data frame containing data on the relative proportions of different 
compounds (columns) in different samples (rows):
```{r}
data("alpinaDataSubset")

head(alpinaDataSubset)[,1:5]
```
The dataset contains the proportional concentration of different floral
scent compounds in different samples. The first column indicates which
population each sample belongs to. For convenience, we separate this column
from the rest of the dataset:
```{r}
alpinaPopulation <- alpinaDataSubset$Population

alpinaData <- alpinaDataSubset[,-1]
```

The second dataset, which we call the *compounds* dataset, should be a 
data frame containing, in each of three columns, the common name, 
SMILES and InChIKey IDs of all the compounds that are 
present in the first dataset:
```{r}
data("alpinaCompSubset")

head(alpinaCompSubset)
```
SMILES and InChIKey are chemical identifiers that are easily obtained for 
each compound by searching for compounds in
[PubChem](https://pubchem.ncbi.nlm.nih.gov/),
or by using various automated tools such as the 
[PubChem Identifier Exchange Service](https://pubchem.ncbi.nlm.nih.gov/idexchange/idexchange.cgi) 
or [The Chemical Translation Service](https://cts.fiehnlab.ucdavis.edu/).
The user is intentionally required to assemble these IDs manually to ensure 
correctness, as lists of compounds very often contain compounds wrongly named, 
wrongly formatted, under various synonyms etc. which prevents efficient
automatic translation of compound names to SMILES and InChIKey.

The name and order of the compounds in the first dataset (column names) has 
to be the same as the name and order of the compounds in the second dataset
(compound column): ---Double check if this is really necessary---
```{r}
table(colnames(alpinaData) == alpinaCompSubset$compound) # Should be all TRUE
```

Once data is correctly formatted we can begin with analyses. 

### Compound classification and dissimilarities
Two functions are used to classify and compare phytochemical compounds,
and are applied to the *compounds* dataset.

The function `NPCTable()` classifies compounds with 
[NPClassifier](https://npclassifier.ucsd.edu/) (Kim et al. 2021).
NPClassifier is a deep-learning tool that attempts to classify 
phytochemical compounds into a hierarchical classification of three groups
(pathway, superclass and class), largely corresponding to 
biosynthetic pathways.
```{r}
alpinaNPC <- NPCTable(compoundData = alpinaCompSubset)

alpinaNPC[1,] # Classification of first compound in dataset
```
This classification is put into a data frame and can be used by 
other *chemdiv* functions.

***

The function `compDis()` compares phytochemical compounds by calcualting
pairwise Jaccard dissimilarities between them. The dissimilarity 
calculations can be based on the biosynthesis and/or structure 
of the compounds. `type = "NPClassifier"` calculates dissimilarities 
based on the classification made by NPClassifier.
`type = "PubChemFingerprint"` and `type = "fMCS"` calculates dissimilarities
based on the structure of the compounds with two different methods.

We calculate compound dissimilarities with `type = "PubChemFingerprint"`.
```{r, message = FALSE}
alpinaCompDis <- compDis(compoundData = alpinaCompSubset,
                         type = "PubChemFingerprint")

alpinaCompDis$fingerDisMat[1:4, 1:4] # Part of compound dissimilarity matrix
```
The output from the function is a list with one or several compound 
dissimilarity matrices, depending on which `type` was used as input. 
This matrix of compound dissimilarities can be visualized and used by 
multiple other functions in the package.


### Diversity calculations
Phytochemical diversity can be calculated for the *proportions* dataset
with functions `calcDiv()`, `calcBetaDiv()` and `calcDivProf()`.

`calcDiv()` calculates alpha-diversity for each sample (row) in the 
*proportions* dataset. The function is able to calculate a 
number of different diversity and evenness indices, depending on
what `type` is used as input. We recommend calculating 
diversity as Hill numbers (Chao et al. 2014), which provides 
a number of advantages, including the use of the parameter 
q which controls the sensitivity of the measure to the relative abundance 
of compounds. This can be done as "normal" Hill diversity, which depends on 
compound richness and evenness, and as functional Hill diversity, 
which additionally depends compound  dissimilarity (Chiu & Chao 2014),
utilizing the compound dissimilarity matrix from `compDis()`. This means that,
for calculations of functional Hill diversity, a set of compounds that are
biosynthetically/structurally different from each other is more diverse
than a similar set of compounds that are biosynthetically/structurally 
more similar to each other.

We calculate functional Hill diversity for q = 1. 
```{r}
alpinaDiv <- calcDiv(sampleData = alpinaData, 
                     compDisMat = alpinaCompDis$fingerDisMat,
                     type = "FuncHillDiv",
                     q = 1)

head(alpinaDiv)
```
The function outputs a data frame with samples as rows and the selected 
`type` of measures as columns.

***

`calcDivProf()` can be used to calculate Hill diversity for a range of 
q-values simultaneously, generating a so called diversity profile. This 
allows for a more nuanced exploration of diversity.

We calculate a diversity profile for functional Hill diversity, using the
default range of q = 0 to q = 3. 
```{r}
alpinaDivProf <- calcDivProf(sampleData = alpinaData,
                             compDisMat = alpinaCompDis$fingerDisMat,
                             type = "FuncHillDiv")

head(alpinaDivProf$divProf)[,1:5] # Part of the diversity profile data frame
```
The function outputs a list with input parameters and the diversity profile 
as a data frame, with samples as rows and diversity values at different
values of q as columns.

***

`calcBetaDiv()` calculates beta-diversity for a set of samples, in the
Hill number framework. The function calculates a single beta-diversity value 
for the supplied sample data. This is calculated as beta = gamma / alpha,
where gamma is the diversity of the pooled data set and alpha represents 
the mean diversity of individual samples.
```{r}
alpinaBetaDiv <- calcBetaDiv(sampleData = alpinaData,
                             compDisMat = alpinaCompDis$fingerDisMat,
                             type = "FuncHillDiv")

alpinaBetaDiv
```


### Sample dissimilarities
Phytochemical dissimilarity can be calculated with the function `sampleDis()`.
This calculates Bray-Curtis dissimilarities and/or Generalized UniFrac 
dissimilarities (Chen et al 2012) between samples in the *proportions* dataset. 
Generalized UniFrac dissimilarities utilize the 
compound dissimilarity matrix from `compDis()`, such that two samples 
containing more biosynthetically/structurally different compounds have a 
higher pairwise dissimilarity than two samples containing more
biosynthetically/structurally similar compounds.

We calculate phytochemical dissimilarity as Generalized UniFrac dissimilarities:
```{r, message = FALSE}
alpinaSampleDis <- sampleDis(sampleData = alpinaData,
                             compDisMat = alpinaCompDis$fingerDisMat,
                             type = "GenUniFrac")

alpinaSampleDis$GenUniFrac[1:4, 1:4] # Part of sample dissimilarity matrix
```
The output from the function is a list with one or several sample 
dissimilarity matrices, depending on which `type` was used as input.


### Molecular network
Function `molNet()` uses a matrix generated by the `compDis()` function to 
create a molecular network of the phytochemical compounds, and calculates 
some properties of the network.

We create a molecular network based on the compound dissimilarity matrix.
We can also include the the NPClassifier classification, where the "pathway"
group will control node colour. We manually set `cutOff = 0.75` in this case.
This limits the number of edges between nodes, as edges are only plotted 
between nodes if their similarity (where similarity = 1 - dissimilarity) 
is larger than the cut-off value.
```{r, message = FALSE}
alpinaNetwork <- molNet(compDisMat = alpinaCompDis$fingerDisMat,
                        npcTable = alpinaNPC,
                        cutOff = 0.75)

summary(alpinaNetwork)
```
The output is a list including the network object, and some basic 
network parameters.


### Chemodiversity and network plots
Once the above functions have calculated different measures of phytochemical
diversity and dissimilarity, two functions can be used to conveniently plot 
the molecular network and the diversity/dissimilarity measures.

`molNetPlot()` creates a basic plot of the molecular network generated
by the `molNet()` function. We create a single molecular network for the whole
dataset, including compound names and the classification by NPClassifier.
```{r, fig.width = 12, fig.height = 8, out.width = "95%"}
molNetPlot(sampleData = alpinaData,
           networkObject = alpinaNetwork$networkObject,
           npcTable = alpinaNPC,
           plotNames = TRUE)
```

Nodes represent individual compounds. They are coloured by their 
"pathway" classification by NPClassifier. Node size corresponds to the mean
proportional concentration of the compounds in the samples. Edge widths 
represent compound similarity, and are only plotted for similarities higher 
than the cutoff value. We see that the floral scent bouquet consists
mostly of compounds belonging to the "Shikimates and Phenylpropanoids" 
pathway. These compounds are connected to each other in a network, but 
separated from the three "Terpenoids" compounds, indicating that the two 
groups of compounds belonging to different pathways are also structurally 
different to each other.

***

`chemDivPlot()` can be used to conveniently create basic plots of the 
different types of diversity and dissimilarity measurements created by 
the functions above. Four types of plots can be created, in any combination.
With argument `compDisMat` a dendrogram visualizing compound dissimilarities is 
created. With argument `divData`, diversity/evenness values are visualized 
with boxplots. With argument `divProfData` a diversity profile will be created. 
With argument `sampleDisMat` sample dissimilarities will be visualized as an 
NMDS plot. Finally, grouping data can be supplied with argument `groupData`.
```{r, fig.width = 12, fig.height = 8, out.width = "95%"}
chemDivPlot(compDisMat = alpinaCompDis$fingerDisMat,
            divData = alpinaDiv,
            divProfData = alpinaDivProf,
            sampleDisMat = alpinaSampleDis$GenUniFrac,
            groupData = alpinaPopulation)
```

The output consists of the selected plots. The dendrogram visualizes 
dissimilarities between compounds in a way complementary to the molecular
network above, with the three terpenoids having a high dissimilarity to 
the other compounds. The boxplot indicates that the functional Hill diversity
of the floral scent compounds is highest in the G1 population. Further
analyses can examine more exactly what components of diversity is higher in 
this population. The diversity profile demonstrates how at q = 1 
(shown also in boxplot) diversity is highest for population G1, but at q = 0,
where compound proportions are not taken into account, diversity is 
highest for population It8. Finally, the NMDS indicates that all three
populations are compositionally/structurally different to each other, and 
that in population It8, dissimilarities between samples in the same 
population is lower than for the other two populations.



### Shortcut function
The function `quickChemDiv()` uses many of the above functions to in one 
simple step calculate and visualize chemodiversity for users wanting to 
quickly explore their data using standard parameters. This can be used
to generate the same four types of plots as above.

```{r, eval = FALSE}
quickChemDiv(compoundData = alpinaCompSubset,
             sampleData = alpinaData,
             groupData = alpinaPopulation,
             outputType = "plots") # Not run
```



## References

Paper for dataset

Paper for chemdiv eventually

Kim et al 2021

Chao et al. 2014

Chiu & Chao 2014

Chen et al 2012



